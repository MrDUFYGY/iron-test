---
import Layout from '../layouts/Layout.astro';
import Nav from '../components/Nav.astro';
---

<Layout>
	<Nav items={[
		{
			title: "Inicio",
			description: "Página principal de nuestro sitio",
			icon: "home",
			link: "/"
		},
		{
			title: "Servicios",
			description: "Conoce nuestros servicios",
			icon: "work",
			link: "/servicios"
		},
		{
			title: "Contacto",
			description: "Ponte en contacto con nosotros",
			icon: "email",
			link: "/contacto"
		},
		{
			title: "Acerca de",
			description: "Conoce más sobre nosotros",
			icon: "info",
			link: "/acerca"
		}
	]} />

	<div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
		<h1 style="text-align: center; margin-bottom: 30px;">Gestión de Alumnos</h1>
		
		<form id="crudForm" style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
			<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
				<div>
					<label for="matricula" style="display: block; margin-bottom: 5px;">Matrícula:</label>
					<input type="text" id="matricula" name="matricula" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
				</div>
				
				<div>
					<label for="nombre" style="display: block; margin-bottom: 5px;">Nombre Completo:</label>
					<input type="text" id="nombre" name="nombre" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
				</div>
				
				<div>
					<label for="carrera" style="display: block; margin-bottom: 5px;">Carrera:</label>
					<select id="carrera" name="carrera" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
						<option value="">Seleccione una carrera</option>
						<option value="Ingeniería en Sistemas">Ingeniería en Sistemas</option>
						<option value="Ingeniería Industrial">Ingeniería Industrial</option>
						<option value="Administración">Administración</option>
						<option value="Contabilidad">Contabilidad</option>
					</select>
				</div>
				
				<div>
					<label for="semestre" style="display: block; margin-bottom: 5px;">Semestre:</label>
					<input type="number" id="semestre" name="semestre" min="1" max="12" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
				</div>
				
				<div>
					<label for="email" style="display: block; margin-bottom: 5px;">Email:</label>
					<input type="email" id="email" name="email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
				</div>
				
				<div>
					<label for="telefono" style="display: block; margin-bottom: 5px;">Teléfono:</label>
					<input type="tel" id="telefono" name="telefono" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
				</div>
			</div>
			
			<div style="display: flex; gap: 10px; margin-top: 20px;">
				<button type="submit" style="
					padding: 10px 20px;
					background-color: #28a745;
					color: white;
					border: none;
					border-radius: 4px;
					cursor: pointer;
				">
					Crear Alumno
				</button>
				<button type="button" id="actualizarBtn" style="
					padding: 10px 20px;
					background-color: #ffc107;
					color: black;
					border: none;
					border-radius: 4px;
					cursor: pointer;
				">
					Actualizar Alumno
				</button>
			</div>
		</form>

		<table style="width: 100%; border-collapse: collapse;">
			<thead>
				<tr style="background-color: #f8f9fa;">
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Matrícula</th>
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Nombre</th>
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Carrera</th>
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Semestre</th>
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Teléfono</th>
					<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Acciones</th>
				</tr>
			</thead>
			<tbody id="tablaDatos">
				<!-- Los datos se agregarán dinámicamente con JavaScript -->
			</tbody>
		</table>
	</div>

    <script type="module">
	const apiUrl = 'https://localhost:44376/ApiHandler/AlumnoAPI.ashx';

	const form = document.getElementById('crudForm');
	const actualizarBtn = document.getElementById('actualizarBtn');
	let idEditando = null;

	async function cargarDatos() {
		const res = await fetch(apiUrl);
		const data = await res.json();
		dibujarTabla(data);
	}

	function dibujarTabla(datos) {
		const tbody = document.getElementById('tablaDatos');
		tbody.innerHTML = '';
		datos.forEach(item => {
			const tr = document.createElement('tr');
			tr.innerHTML = `
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.matricula}</td>
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.nombre}</td>
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.carrera}</td>
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.semestre}</td>
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.email}</td>
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.telefono}</td>
				<td style="padding: 8px; border-bottom: 1px solid #ddd;">
					<button onclick="editarItem('${item.id}')" style="...">Editar</button>
					<button onclick="eliminarItem('${item.id}')" style="...">Eliminar</button>
				</td>
			`;
			tbody.appendChild(tr);
		});
	}

	if (form) {
		form.addEventListener('submit', async function (e) {
			e.preventDefault();
			const datos = obtenerDatosFormulario();

			if (datos) {
				await fetch(apiUrl, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'create', data: datos })
				});
				form.reset();
				idEditando = null;
				cargarDatos();
			}
		});
	}

	if (actualizarBtn) {
		actualizarBtn.addEventListener('click', async function () {
			if (idEditando) {
				const datos = obtenerDatosFormulario();
				if (datos) {
					datos.id = idEditando;
					await fetch(apiUrl, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update', data: datos })
					});
					form.reset();
					idEditando = null;
					cargarDatos();
				}
			}
		});
	}

	window.editarItem = async function (id) {
		const res = await fetch(`${apiUrl}?id=${id}`);
		const item = await res.json();

		document.getElementById('matricula').value = item.matricula;
		document.getElementById('nombre').value = item.nombre;
		document.getElementById('carrera').value = item.carrera;
		document.getElementById('semestre').value = item.semestre;
		document.getElementById('email').value = item.email;
		document.getElementById('telefono').value = item.telefono;

		idEditando = item.id;
	};

	window.eliminarItem = async function (id) {
		await fetch(apiUrl, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ action: 'delete', id })
		});
		cargarDatos();
	};

	function obtenerDatosFormulario() {
		const matricula = document.getElementById('matricula').value.trim();
		const nombre = document.getElementById('nombre').value.trim();
		const carrera = document.getElementById('carrera').value.trim();
		const semestre = parseInt(document.getElementById('semestre').value);
		const email = document.getElementById('email').value.trim();
		const telefono = document.getElementById('telefono').value.trim();

		if (matricula && nombre && carrera && semestre && email && telefono) {
			return { matricula, nombre, carrera, semestre, email, telefono };
		}
		return null;
	}

	// Carga inicial
	cargarDatos();
</script>




</Layout>
