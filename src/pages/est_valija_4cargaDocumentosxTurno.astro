---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css";
import FileInputGroup from '../components/FileInputGroup.astro';

const pdfPreviewUrl = "/assets/simulacion.pdf";
---

<Layout>
  <!-- Modal de validación de montos -->
  <div id="validation-dialog" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg p-6 max-w-6xl w-full relative z-50">
      <h3 class="text-lg font-semibold mb-4">Validación de Archivos</h3>
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="border rounded overflow-hidden h-96">
          <iframe id="preview-pdf1" class="w-full h-full" title="Vista previa PDF 1"></iframe>
        </div>
        <div class="border rounded overflow-hidden h-96">
          <iframe id="preview-pdf2" class="w-full h-full" title="Vista previa PDF 2"></iframe>
        </div>
        <div class="border rounded overflow-hidden h-96">
          <iframe id="preview-pdf3" class="w-full h-full" title="Vista previa PDF 3"></iframe>
        </div>
      </div>
      <div class="flex justify-end space-x-4">
        <button id="cancel-validation" class="px-6 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Cancelar</button>
        <button id="confirm-and-seal" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">Confirmar y Sellar</button>
        <button id="reject-validation" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">Hay Discrepancias</button>
      </div>
    </div>
  </div>

    <div class="bg-gray-100 font-sans flex  items-center justify-center">
    <div x-data="{ openTab: 1 }" class="mt-1">
        <div class="p-5 mx-auto">
            <div class="mb-4 flex space-x-4 p-2 bg-white rounded-lg shadow-md">
                <button x-on:click="openTab = 1" :class="{ 'bg-blue-600 text-white': openTab === 1 }" class="flex-1 py-2 px-4 rounded-md focus:outline-none focus:shadow-outline-blue transition-all duration-300">Mediciones Comprobantes</button>
                <button x-on:click="openTab = 2" :class="{ 'bg-blue-600 text-white': openTab === 2 }" class="flex-1 py-2 px-4 rounded-md focus:outline-none focus:shadow-outline-blue transition-all duration-300">Listados Tag</button>
                <button x-on:click="openTab = 3" :class="{ 'bg-blue-600 text-white': openTab === 3 }" class="flex-1 py-2 px-4 rounded-md focus:outline-none focus:shadow-outline-blue transition-all duration-300">Listados Contadores</button>
                <button x-on:click="openTab = 4" :class="{ 'bg-blue-600 text-white': openTab === 4 }" class="flex-1 py-2 px-4 rounded-md focus:outline-none focus:shadow-outline-blue transition-all duration-300">Hojas OpenPOS</button>
            </div>

            <div x-show="openTab === 1" class="transition-all duration-300 bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-600">
                <h2 class="text-2xl font-semibold mb-2 text-blue-600">Listado de Mediciones con Comprobantes</h2>
                <p class="text-gray-700">Cargue los archivos PDF de las mediciones con comprobantes.</p>
                <FileInputGroup
                groupIdBase="Mediciones y comprobantes"
                tituloProceso="Mediciones y comprobantes"
                pdfPreviewUrl={pdfPreviewUrl}
            />
            </div>

            <div x-show="openTab === 2" class="transition-all duration-300 bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-600">
        <h2 class="text-2xl font-semibold mb-2 text-blue-600">Listado de tarjetas con Tag</h2>
                <p class="text-gray-700">Cargue los listados PDF de las tarjetas con tag.</p>
                <FileInputGroup
                groupIdBase="Listado de tarjetas con Tag"
                tituloProceso="Listado de tarjetas con Tag"
                pdfPreviewUrl={pdfPreviewUrl}
            />
            </div>

            <div x-show="openTab === 3" class="transition-all duration-300 bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-600">
                <h2 class="text-2xl font-semibold mb-2 text-blue-600">Listado de Contadores</h2>
                <p class="text-gray-700">Cargue los listados contadores pára su validación.</p>
                <FileInputGroup
                groupIdBase="Listado de Contadores"
                tituloProceso="Listado de Contadores"
                pdfPreviewUrl={pdfPreviewUrl}
            />
            </div>

            <div x-show="openTab === 4" class="transition-all duration-300 bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-600">
                <h2 class="text-2xl font-semibold mb-2 text-blue-600">Listado de Open POS</h2>
                <p class="text-gray-700">Cargue los listados Open POS para su validación.</p>
                <FileInputGroup
                groupIdBase="Listado de Open POS"
                tituloProceso="Listado de Open POS"
                pdfPreviewUrl={pdfPreviewUrl}
            />
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2/dist/alpine.min.js" defer></script>

    <!-- Modal Global para Vista Previa de PDF -->
    <div id="pdf-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
      <div style="min-height: 100%; display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem;">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; width: 100%; max-width: 900px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <!-- Encabezado del Modal -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 1.25rem; font-weight: 500; color: #111827; margin: 0;">
              Vista previa del documento
            </h3>
            <button id="close-pdf-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0.25rem 0.5rem; margin: -0.5rem -0.5rem -0.5rem auto;">
              &times;
            </button>
          </div>
          
          <!-- Contenido del PDF -->
          <div style="margin: 1rem 0; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; background: #f5f5f5;">
            <iframe id="pdf-viewer" src="" style="width: 100%; height: 70vh; min-height: 500px; border: none;"></iframe>
          </div>
          
          <!-- Pie del Modal - Acciones -->
          <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
              <p id="pdf-file-info" style="font-size: 0.875rem; color: #374151; margin: 0; font-weight: 500;"></p>
              <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0 0;">¿Deseas subir este archivo?</p>
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
              <button type="button" id="cancel-pdf-upload" style="padding: 0.5rem 1.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; background: white; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s;">
                Cancelar
              </button>
              <button type="button" id="confirm-pdf-upload" style="padding: 0.5rem 1.5rem; font-size: 0.875rem; font-weight: 500; color: white; background: #2563eb; border: none; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s;">
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
<script>
  document.addEventListener('astro:page-load', () => {
    // Elementos del DOM
    const confirmDialog = document.getElementById('confirm-dialog');
    const validationDialog = document.getElementById('validation-dialog');
    
    if (!confirmDialog || !validationDialog) {
      console.error('No se encontraron los elementos de diálogo necesarios');
      return;
    }
    
    // Mostrar diálogo de confirmación
    const showConfirmDialog = () => {
      if (confirmDialog) {
        confirmDialog.style.display = 'flex';
        confirmDialog.classList.remove('hidden');
      }
    };

    // Ocultar diálogo de confirmación
    const hideConfirmDialog = () => {
      if (confirmDialog) {
        confirmDialog.style.display = 'none';
        confirmDialog.classList.add('hidden');
      }
    };

    // Mostrar diálogo de validación
    const showValidationDialog = () => {
      if (validationDialog) {
        validationDialog.style.display = 'flex';
        validationDialog.classList.remove('hidden');
      }
    };

    // Ocultar diálogo de validación
    const hideValidationDialog = () => {
      if (validationDialog) {
        validationDialog.style.display = 'none';
        validationDialog.classList.add('hidden');
      }
    };

    // Event listeners para los botones
    document.addEventListener('click', (e) => {
      if (!e.target) return;
      
      // Cerrar diálogos al hacer clic fuera del contenido
      if (e.target === confirmDialog) {
        hideConfirmDialog();
      } else if (e.target === validationDialog) {
        hideValidationDialog();
      }
    });

    // Evento personalizado para mostrar el diálogo de confirmación
    document.addEventListener('showConfirmDialog', () => {
      showConfirmDialog();
    });

    // Evento personalizado para mostrar el diálogo de validación
    document.addEventListener('showValidationDialog', () => {
      showValidationDialog();
    });

    // Configurar botones del diálogo de confirmación
    const confirmUploadBtn = document.getElementById('confirm-upload');
    const cancelUploadBtn = document.getElementById('cancel-upload');
    
    if (confirmUploadBtn) {
      confirmUploadBtn.addEventListener('click', () => {
        hideConfirmDialog();
      });
    }
    
    if (cancelUploadBtn) {
      cancelUploadBtn.addEventListener('click', () => {
        hideConfirmDialog();
      });
    }
  });

  // Script para manejar el modal global de vista previa de PDF
  document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const modal = document.getElementById('pdf-preview-modal');
    const pdfViewer = document.getElementById('pdf-viewer');
    const fileInfo = document.getElementById('pdf-file-info');
    const confirmBtn = document.getElementById('confirm-pdf-upload');
    const cancelBtn = document.getElementById('cancel-pdf-upload');
    const closeBtn = document.getElementById('close-pdf-modal');

    // Función para cerrar el modal
    function closeModal() {
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // Limpiar el visor PDF
        if (pdfViewer) {
          pdfViewer.src = '';
        }
      }
    }

    // Cerrar al hacer clic en el botón de cierre
    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }

    // Cerrar al hacer clic en Cancelar
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        const inputId = modal?.dataset.inputId;
        const inputBase = modal?.dataset.inputBase;
        const fileInput = document.getElementById(inputId);
        const fileNameElement = document.getElementById(`${inputBase}-filename`);
        const status1 = document.getElementById(`${inputBase}-status1`);
        
        if (fileInput) fileInput.value = '';
        if (fileNameElement) fileNameElement.textContent = '';
        if (status1) status1.className = 'w-3 h-3 rounded-full bg-gray-300';
        
        closeModal();
      });
    }

    // Confirmar la carga del archivo
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        const inputId = modal?.dataset.inputId;
        const inputBase = modal?.dataset.inputBase;
        const status1 = document.getElementById(`${inputBase}-status1`);
        
        if (status1) {
          status1.className = 'w-3 h-3 rounded-full bg-green-500';
        }
        
        // Disparar evento personalizado
        const event = new CustomEvent('pdfConfirmed', {
          detail: { 
            inputId: inputId,
            fileName: document.getElementById(inputId)?.files?.[0]?.name || ''
          }
        });
        document.dispatchEvent(event);
        
        closeModal();
      });
    }

    // Cerrar al hacer clic fuera del contenido del modal
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });
    }

    // Cerrar con la tecla Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal && modal.style.display === 'block') {
        closeModal();
      }
    });
  });
</script>

</Layout>
