---
// Este archivo se usa como componente, por eso NO lleva <Layout>
const { usuario } = Astro.props;
const nombreUsuario = usuario?.nombre ?? "Tú";
---

<div class="bg-gray-100 p-6 space-y-6 min-h-screen">
  <!-- Título -->
  <h2 class="text-2xl font-bold text-gray-700">Histórico de incidencias</h2>

  <!-- Lista de tarjetas -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Tarjeta de incidencia -->
    <div class="bg-white rounded-lg shadow-md p-4 border border-gray-300 group cursor-pointer" onclick="abrirModal()">
      <div class="flex flex-col gap-2">
        <h3 class="text-lg font-semibold text-blue-600">⚠️ Error en carga de documento</h3>
        <p class="text-sm text-gray-600">De: Juan Pérez → Para: Soporte Técnico</p>
        <p class="text-xs text-gray-500">📅 29/07/2025 🕐 10:12 a.m.</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modalIncidencia" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-lg rounded-lg shadow-lg p-6 relative">
    <button onclick="cerrarModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>

    <h3 class="text-xl font-bold mb-2 text-blue-600">⚠️ Error en carga de documento</h3>
    <p class="text-sm text-gray-600 mb-1">De: Juan Pérez → Para: Soporte Técnico</p>
    <p class="text-xs text-gray-500 mb-4">📅 29/07/2025 🕐 10:12 a.m.</p>

    <div class="bg-gray-100 p-3 rounded border border-gray-200 mb-3 max-h-40 overflow-y-auto space-y-2" id="chatMensajes">
      <p><strong>Soporte:</strong> Ya reiniciamos el servicio, inténtalo de nuevo.</p>
      <p><strong>Juan:</strong> Sigue fallando, pero ahora es distinto.</p>
    </div>

    <!-- Textarea para escribir -->
    <textarea id="nuevoMensaje" rows="2" placeholder="Escribe tu respuesta..." class="w-full rounded-md border border-gray-300 p-2 text-sm resize-none focus:outline-none focus:ring focus:border-blue-300 mb-2"></textarea>

    <div class="flex items-center gap-2">
      <input id="confirmarEnvio" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
      <label for="confirmarEnvio" class="text-sm text-gray-700">Confirmar envío</label>
      <button onclick="enviarMensaje()" class="ml-auto bg-blue-600 text-white text-sm px-3 py-1 rounded hover:bg-blue-700 transition disabled:opacity-50" id="btnEnviar" disabled>Enviar</button>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById("modalIncidencia");
  const btnEnviar = document.getElementById("btnEnviar");
  const confirmar = document.getElementById("confirmarEnvio");

  function abrirModal() {
    modal.classList.remove("hidden");
  }

  function cerrarModal() {
    modal.classList.add("hidden");
  }

  confirmar.addEventListener("change", () => {
    btnEnviar.disabled = !confirmar.checked;
  });

  function enviarMensaje() {
    const mensaje = document.getElementById("nuevoMensaje").value.trim();
    if (!mensaje) return;

    const contenedor = document.getElementById("chatMensajes");
    const nuevoP = document.createElement("p");
    nuevoP.innerHTML = `<strong>${"{{nombreUsuario}}"}</strong>: ${mensaje}`;
    contenedor.appendChild(nuevoP);

    // Limpiar campos
    document.getElementById("nuevoMensaje").value = "";
    confirmar.checked = false;
    btnEnviar.disabled = true;
  }
</script>
