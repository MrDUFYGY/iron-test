---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css";
---

<Layout>

    <div class="flex flex-col space-y-4">
        <h1 class="text-2xl font-bold">Hojas de liquidación OpenPos</h1>
        <p class="text-gray-600">Suba las hojas de liquidación de OpenPos por turno</p>
    </div>

<!-- Sección: Subida de archivos por turno -->
<div class="mt-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

    <!-- Turno 1 -->
    <div class="border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
      <div class="flex justify-between items-center mb-2">
        <label class="block text-sm font-medium text-gray-700">Turno 1 – Liquidación OpenPos</label>
        <div class="flex space-x-2">
          <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-turno1"></div>
          <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-turno1"></div>
        </div>
      </div>
      <input type="file" id="input-turno1" accept=".pdf"
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
    </div>
  
    <!-- Turno 2 -->
    <div class="border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
      <div class="flex justify-between items-center mb-2">
        <label class="block text-sm font-medium text-gray-700">Turno 2 – Liquidación OpenPos</label>
        <div class="flex space-x-2">
          <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-turno2"></div>
          <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-turno2"></div>
        </div>
      </div>
      <input type="file" id="input-turno2" accept=".pdf"
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
    </div>
  
    <!-- Turno 3 -->
    <div class="border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
      <div class="flex justify-between items-center mb-2">
        <label class="block text-sm font-medium text-gray-700">Turno 3 – Liquidación OpenPos</label>
        <div class="flex space-x-2">
          <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-turno3"></div>
          <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-turno3"></div>
        </div>
      </div>
      <input type="file" id="input-turno3" accept=".pdf"
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
    </div>
  
</div>

<!-- Modal de confirmación -->
<dialog id="modal-confirmacion" class="rounded-lg p-0 w-full max-w-[80%]">
  <div class="p-6 bg-white rounded-lg shadow-lg relative">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Confirmar hoja de liquidación</h2>
    <div class="mb-4 border rounded overflow-hidden h-80">
      <iframe id="preview-pdf" class="w-full h-full" title="Vista previa PDF"></iframe>
    </div>
    <div class="flex justify-end space-x-2">
      <button id="btn-cancelar" class="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">
        Cancelar
      </button>
      <button id="btn-confirmar" class="px-4 py-2 text-sm text-white bg-green-600 rounded hover:bg-green-700">
        Confirmar
      </button>
    </div>
  </div>
</dialog>

<!-- Contenedor para los botones -->
<div class="mt-8 flex justify-center space-x-4">
  <!-- Botón normal de guardar -->
  <a href="/" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">
    Guardar
  </a>

  <!-- Botón de sellar que se habilita cuando se suben los 3 PDFs -->
  <button id="btn-sellar" class="px-6 py-2 bg-blue-600 text-white rounded-md opacity-50 cursor-not-allowed transition" disabled>
    Sellar y guardar
  </button>
</div>

<script>
  // Función para verificar si todos los PDFs están confirmados
  function verificarPDFs() {
    const punto1Turno1 = document.getElementById('punto1-turno1');
    const punto1Turno2 = document.getElementById('punto1-turno2');
    const punto1Turno3 = document.getElementById('punto1-turno3');
    
    const btnSellar = document.getElementById('btn-sellar');

    if (!punto1Turno1 || !punto1Turno2 || !punto1Turno3 || !btnSellar) return;

    // Verificar si todos los puntos tienen la clase bg-green-500
    const todosConfirmados = [punto1Turno1, punto1Turno2, punto1Turno3].every(punto => 
      punto.classList.contains('bg-green-500')
    );

    if (todosConfirmados) {
      // Habilitar el botón
      btnSellar.classList.remove('opacity-50', 'cursor-not-allowed');
      btnSellar.classList.add('hover:bg-blue-700');
      btnSellar.removeAttribute('disabled');
    } else {
      // Mantener el botón deshabilitado
      btnSellar.classList.add('opacity-50', 'cursor-not-allowed');
      btnSellar.classList.remove('hover:bg-blue-700');
      btnSellar.setAttribute('disabled', '');
    }
  }

  // Observar cambios en los puntos de estado
  const observer = new MutationObserver(verificarPDFs);
  
  // Observar cambios de clase en cada punto
  ['punto1-turno1', 'punto1-turno2', 'punto1-turno3'].forEach(id => {
    const elemento = document.getElementById(id);
    if (elemento) {
      observer.observe(elemento, { attributes: true });
    }
  });

  // Verificación inicial
  verificarPDFs();
</script>

<script type="module">
  // Función para manejar la subida de archivos
  function setupFileUpload(inputId, punto1Id, punto2Id) {
    const input = document.getElementById(inputId);
    const punto1 = document.getElementById(punto1Id);
    const punto2 = document.getElementById(punto2Id);
    const modal = document.getElementById('modal-confirmacion');
    const previewPdf = document.getElementById('preview-pdf');
    const btnCancelar = document.getElementById('btn-cancelar');
    const btnConfirmar = document.getElementById('btn-confirmar');

    if (!input || !punto1 || !punto2 || !modal || !previewPdf || !btnCancelar || !btnConfirmar) return;

    input.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file && file.type === 'application/pdf') {
        // Crear URL del archivo para el iframe
        const fileUrl = URL.createObjectURL(file);
        previewPdf.src = fileUrl;
        
        // Mostrar modal
        modal.showModal();

        // Manejar cancelación
        btnCancelar.onclick = () => {
          modal.close();
          input.value = '';
          URL.revokeObjectURL(fileUrl);
        };

        // Manejar confirmación
        btnConfirmar.onclick = () => {
          punto1.classList.remove('bg-gray-300');
          punto1.classList.add('bg-green-500');
          modal.close();
          URL.revokeObjectURL(fileUrl);
        };
      }
    });
  }

  // Configurar los tres inputs
  setupFileUpload('input-turno1', 'punto1-turno1', 'punto2-turno1');
  setupFileUpload('input-turno2', 'punto1-turno2', 'punto2-turno2');
  setupFileUpload('input-turno3', 'punto1-turno3', 'punto2-turno3');
</script>

</Layout>