---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css";
import HuellaConfirmacion from '../components/ConfirmHuella.astro';
---

<Layout>
    <div class="flex flex-col space-y-4">
        <h1 class="text-2xl font-bold">Jarreo de Documentos</h1>
        <p class="text-gray-600">Complete los siguientes pasos de documentación</p>
    </div>

    <!-- Contenedor principal de inputs -->
    <div class="mt-10 space-y-6">
        <!-- Paso 1: Textarea de Envío -->
        <div class="border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">Envío</label>
            <textarea 
                id="input-envio" 
                rows="4" 
                maxlength="500"
                class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                placeholder="Escriba su mensaje de envío..."
            ></textarea>
            <div class="flex justify-between items-center mt-2">
                <span id="char-count" class="text-sm text-gray-500">0 / 100 caracteres</span>
                <button 
                    id="btn-enviar" 
                    class="bg-blue-600 text-white px-4 py-1 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Enviar
                </button>
            </div>
            <div id="envio-estado" class="hidden mt-4 flex items-center justify-center space-x-2">
                <span class="material-icons animate-spin text-blue-600">autorenew</span>
                <span class="text-blue-600 font-semibold">Enviando...</span>
            </div>
        </div>

        <!-- Paso 2: Input Comprobante -->
        <div id="seccion-comprobante" class="hidden border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-medium text-gray-700">Comprobante / Caratula</label>
                <div class="flex space-x-2">
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-comprobante"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-comprobante"></div>
                </div>
            </div>
            <input 
                type="file" 
                id="input-comprobante" 
                accept=".pdf"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
            <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
        </div>

        <!-- Paso 3: Input Hoja de Extracciones -->
        <div id="seccion-extracciones" class="hidden border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-medium text-gray-700">Hoja de Extracciones</label>
                <div class="flex space-x-2">
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-extracciones"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-extracciones"></div>
                </div>
            </div>
            <input 
                type="file" 
                id="input-extracciones" 
                accept=".pdf"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
            <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
        </div>

        <!-- Paso 4: Input Histórico de Movimientos de Carburante -->
        <div id="seccion-carburante" class="hidden border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-medium text-gray-700">Histórico de Movimientos de Carburante (Retorno)</label>
                <div class="flex space-x-2">
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-carburante"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-carburante"></div>
                </div>
            </div>
            <input 
                type="file" 
                id="input-carburante" 
                accept=".pdf"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
            <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
        </div>

        <!-- Paso 5: Input Ticket -->
        <div id="seccion-ticket" class="hidden border border-dashed border-gray-300 rounded-md p-4 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-medium text-gray-700">Ticket</label>
                <div class="flex space-x-2">
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto1-ticket"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-300" id="punto2-ticket"></div>
                </div>
            </div>
            <input 
                type="file" 
                id="input-ticket" 
                accept=".pdf"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
            <p class="text-xs text-gray-400 italic mt-1">Archivo PDF requerido</p>
        </div>
    </div>

    <HuellaConfirmacion />

    <!-- Modal de confirmación -->
    <dialog id="modal-confirmacion" class="rounded-lg p-0 w-full max-w-[80%]">
        <div class="p-6 bg-white rounded-lg shadow-lg relative">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Confirmar archivo</h2>
            <div class="mb-4 border rounded overflow-hidden h-80">
                <iframe id="preview-pdf" class="w-full h-full" title="Vista previa PDF"></iframe>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="btn-cancelar" class="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200">
                    Cancelar
                </button>
                <button id="btn-confirmar" class="px-4 py-2 text-sm text-white bg-green-600 rounded hover:bg-green-700">
                    Confirmar
                </button>
            </div>
        </div>
    </dialog>

    <script type="module">
        const envioTextarea = document.getElementById('input-envio');
        const envioEstado = document.getElementById('envio-estado');
        const seccionComprobante = document.getElementById('seccion-comprobante');

        const charCount = document.getElementById('char-count');
        const btnEnviar = document.getElementById('btn-enviar');
        
        // Función para manejar el conteo de caracteres y habilitar el botón
        envioTextarea.addEventListener('input', (e) => {
            const currentLength = e.target.value.trim().length;
            charCount.textContent = `${currentLength} / 100 caracteres`;
            
            // Habilitar o deshabilitar el botón según el conteo de caracteres
            if (currentLength >= 100) {
                btnEnviar.disabled = false;
            } else {
                btnEnviar.disabled = true;
            }
        });
        
        // Función para manejar el envío
        btnEnviar.addEventListener('click', () => {
            // Deshabilitar textarea y botón durante el envío
            envioTextarea.disabled = true;
            btnEnviar.disabled = true;
            
            // Mostrar animación de carga
            envioEstado.classList.remove('hidden');
            
            // Simular envío con timeout
            setTimeout(() => {
                envioEstado.classList.add('hidden');
                seccionComprobante.classList.remove('hidden');
            }, 5000);
        });

        // Función para manejar la subida de archivos con modal de confirmación
        function setupFileUpload(inputId, punto1Id, punto2Id, nextSectionId) {
            const input = document.getElementById(inputId);
            const punto1 = document.getElementById(punto1Id);
            const punto2 = document.getElementById(punto2Id);
            const modal = document.getElementById('modal-confirmacion');
            const previewPdf = document.getElementById('preview-pdf');
            const btnCancelar = document.getElementById('btn-cancelar');
            const btnConfirmar = document.getElementById('btn-confirmar');
            const nextSection = document.getElementById(nextSectionId);

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    const fileUrl = URL.createObjectURL(file);
                    previewPdf.src = fileUrl;
                    
                    modal.showModal();

                    btnCancelar.onclick = () => {
                        modal.close();
                        input.value = '';
                        URL.revokeObjectURL(fileUrl);
                    };

                    btnConfirmar.onclick = () => {
                        punto1.classList.remove('bg-gray-300');
                        punto1.classList.add('bg-green-500');
                        modal.close();
                        URL.revokeObjectURL(fileUrl);
                        
                        // Mostrar siguiente sección
                        if (nextSection) {
                            nextSection.classList.remove('hidden');
                        }
                    };
                }
            });
        }

        // Configurar los inputs con modal de confirmación
        setupFileUpload('input-comprobante', 'punto1-comprobante', 'punto2-comprobante', 'seccion-extracciones');
        setupFileUpload('input-extracciones', 'punto1-extracciones', 'punto2-extracciones', 'seccion-carburante');
        setupFileUpload('input-carburante', 'punto1-carburante', 'punto2-carburante', 'seccion-ticket');
        setupFileUpload('input-ticket', 'punto1-ticket', 'punto2-ticket', null);
    </script>
</Layout>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  /* Estilos para los iconos de Material Design */
  :global(.material-icons) {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
  }
  
  /* Animación de giro */
  .animate-spin {
      animation: spin 1.5s linear infinite;
  }
  
  @keyframes spin {
      from {
          transform: rotate(0deg);
      }
      to {
          transform: rotate(360deg);
      }
  }
</style>
